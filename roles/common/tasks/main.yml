- name: Wait for cloud init to finish
  cloud_init_data_facts:
    filter: status
  register: res
  until: "res.cloud_init_data_facts.status.v1.stage is defined and not res.cloud_init_data_facts.status.v1.stage"
  retries: 50
  delay: 5

# TODO (msenin): double-check and disable, that's needed only for master host
- name: Create system.d conf directory
  file:
    path: /etc/systemd/system.conf.d/
    state: directory
    recurse: yes

# TODO (msenin): double-check and disable, that's needed only for master host
- name: Set up system proxy
  template:
    src: 10-default-env.j2
    dest: /etc/systemd/system.conf.d/10-default-env.conf
    owner: root
    group: root
    mode: 0644

- name: Create docker.service.d conf directory
  file:
    path: /etc/systemd/system/docker.service.d/
    state: directory
    recurse: yes

- name: Set up proxy for docker service
  template:
    src: http_proxy.j2
    dest: /etc/systemd/system/docker.service.d/http-proxy.conf
    owner: root
    group: root
    mode: 0644

- name: Add proxy export to /etc/profile
  lineinfile:
    dest: /etc/profile.d/Z100-custom-proxy.sh
    line: |
      export HTTP_PROXY={{ http_proxy }}
      export HTTPS_PROXY={{ http_proxy }}
    owner: root
    state: present
    create: yes

- name: Force systemd to reread configs (2.4 and above)
  systemd: daemon_reload=yes

- name: Set up apt proxy
  template:
    src: proxy.j2
    dest: /etc/apt/apt.conf.d/proxy.conf
    owner: root
    group: root
    mode: 0644

- name: Install prometheus node exporter
  apt:
    name: prometheus-node-exporter
    state: present
    update_cache: yes
  environment:
    http_proxy: "{{ http_proxy }}"
    https_proxy: "{{ http_proxy }}"
